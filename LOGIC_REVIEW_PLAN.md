# ğŸ” Ø®Ø·Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ù†Ø·Ù‚ÙŠØ© Ø§Ù„Ø´Ø§Ù…Ù„Ø© - AI-Manus SaaS
**Ø§Ù„ØªØ§Ø±ÙŠØ®:** 2025-12-26  
**Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹:** https://github.com/raglox/ai-manus  
**Ø§Ù„Ø­Ø§Ù„Ø©:** Ù…Ø±Ø§Ø¬Ø¹Ø© Ø´Ø§Ù…Ù„Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ù†ØªØ§Ø¬

---

## ğŸ“‹ Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹

### Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„ØªÙ‚Ù†ÙŠØ©
- **Backend:** FastAPI + Python 3.11+
- **Frontend:** Vue 3 + TypeScript
- **Database:** MongoDB + Beanie ODM
- **Cache:** Redis
- **Payments:** Stripe (v14.1.0)
- **Auth:** JWT (access + refresh tokens)
- **Sandbox:** Docker containers
- **Real-time:** WebSocket/Socket.IO

### Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©
âœ… **Phase 1-4:** Backend Core (100%)  
âœ… **Phase 5:** Frontend Real-Time Dashboard (100%)  
âœ… **Phase 6:** Stripe Billing Integration (100%)  
âœ… **Phase 7:** Frontend Billing UI (100%)  
â³ **Phase 8:** Production Deployment (0%)

---

## ğŸ¯ Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©

### 1ï¸âƒ£ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙ†Ø§Ø³Ù‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Data Consistency)
- âœ“ ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø¨ÙŠÙ† Domain Models Ùˆ MongoDB Documents
- âœ“ ØªØ²Ø§Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨ÙŠÙ† Frontend TypeScript Ùˆ Backend Python
- âœ“ ØµØ­Ø© Ø§Ù„ÙÙ‡Ø§Ø±Ø³ (Indexes) ÙˆØ§Ù„Ù‚ÙŠÙˆØ¯ (Constraints)

### 2ï¸âƒ£ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ (Business Logic)
- âœ“ ØµØ­Ø© Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙÙˆØªØ±Ø© ÙˆØ§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª
- âœ“ Ø¯Ù‚Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø´Ù‡Ø±ÙŠØ© (Usage Limits)
- âœ“ Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ© (Trial Logic)
- âœ“ Ø³Ù„ÙˆÙƒ BillingMiddleware

### 3ï¸âƒ£ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙƒØ§Ù…Ù„ Ø§Ù„Ø£Ù†Ø¸Ù…Ø© (Integration)
- âœ“ ØµØ­Ø© Stripe Webhooks
- âœ“ ØªØ²Ø§Ù…Ù† Frontend â†” Backend API
- âœ“ Authentication Flow
- âœ“ Multi-tenancy Isolation

### 4ï¸âƒ£ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ù…Ø§Ù† (Security)
- âœ“ JWT Token Management
- âœ“ Stripe Webhook Verification
- âœ“ User Data Isolation
- âœ“ CORS Configuration

### 5ï¸âƒ£ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø¯Ø§Ø¡ (Performance)
- âœ“ Database Query Optimization
- âœ“ Caching Strategy
- âœ“ API Response Times
- âœ“ Memory Leaks

---

## ğŸ” Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø­Ø±Ø¬Ø© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©

### ğŸ”´ Ù…Ù†Ø·Ù‚Ø© 1: Ø¯ÙˆØ±Ø© Ø­ÙŠØ§Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ (Subscription Lifecycle)

#### Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ­Ù‚Ù‚:
```
1. User Registration
   â””â”€> Create FREE subscription (10 runs/month)
       â””â”€> monthly_agent_runs = 0
       â””â”€> monthly_agent_runs_limit = 10
       â””â”€> status = ACTIVE

2. Trial Activation
   â”œâ”€> Check: subscription.plan == FREE
   â”œâ”€> Check: subscription.status == ACTIVE
   â”œâ”€> Check: subscription.trial_end == None
   â””â”€> Update:
       â”œâ”€> status = TRIALING
       â”œâ”€> trial_start = now
       â”œâ”€> trial_end = now + 14 days
       â”œâ”€> monthly_agent_runs_limit = 50
       â””â”€> monthly_agent_runs = 0 (reset)

3. Upgrade to BASIC/PRO
   â”œâ”€> Create Stripe Checkout Session
   â”œâ”€> Redirect to Stripe
   â””â”€> Webhook: checkout.session.completed
       â””â”€> Update:
           â”œâ”€> plan = BASIC/PRO
           â”œâ”€> status = ACTIVE
           â”œâ”€> stripe_subscription_id = sub_xxx
           â”œâ”€> stripe_customer_id = cus_xxx
           â”œâ”€> monthly_agent_runs_limit = 1000/5000
           â”œâ”€> current_period_start = now
           â”œâ”€> current_period_end = now + 30 days
           â””â”€> monthly_agent_runs = 0 (reset)

4. Monthly Reset
   â”œâ”€> Webhook: invoice.paid (new billing period)
   â””â”€> Update:
       â”œâ”€> current_period_start = new_start
       â”œâ”€> current_period_end = new_end
       â””â”€> monthly_agent_runs = 0 (reset)

5. Cancellation
   â”œâ”€> User clicks "Cancel Subscription"
   â”œâ”€> Redirect to Stripe Customer Portal
   â”œâ”€> User cancels subscription
   â””â”€> Webhook: customer.subscription.updated
       â””â”€> Update:
           â”œâ”€> cancel_at_period_end = True
           â”œâ”€> canceled_at = now
           â””â”€> (keep plan active until period_end)

6. Subscription Expired
   â””â”€> Webhook: customer.subscription.deleted
       â””â”€> Update:
           â”œâ”€> plan = FREE
           â”œâ”€> status = ACTIVE
           â”œâ”€> monthly_agent_runs_limit = 10
           â””â”€> monthly_agent_runs = 0 (reset)
```

#### â“ Ø£Ø³Ø¦Ù„Ø© Ø­Ø±Ø¬Ø©:
- [ ] **Q1:** Ø¹Ù†Ø¯ Ø§Ù„ØªØ±Ù‚ÙŠØ© Ù…Ù† TRIAL Ø¥Ù„Ù‰ BASICØŒ Ù‡Ù„ ÙŠØªÙ… reset monthly_agent_runsØŸ
- [ ] **Q2:** Ø¥Ø°Ø§ Ø§Ù†ØªÙ‡Øª Ø§Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ© ÙˆÙ„Ù… ÙŠØªØ±Ù‚ÙÙ‘ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ù…Ø§Ø°Ø§ ÙŠØ­Ø¯Ø«ØŸ
- [ ] **Q3:** Ù‡Ù„ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ trial Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¦Ù‡ØŸ
- [ ] **Q4:** Ø¹Ù†Ø¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØŒ Ù‡Ù„ ÙŠØ³ØªÙ…Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ø­ØªÙ‰ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙØªØ±Ø©ØŸ
- [ ] **Q5:** Ø¹Ù†Ø¯ ÙØ´Ù„ Ø¯ÙØ¹Ø© StripeØŒ Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ØŸ

---

### ğŸ”´ Ù…Ù†Ø·Ù‚Ø© 2: BillingMiddleware Logic

#### Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ø­Ø§Ù„ÙŠ:
```python
async def dispatch(request, call_next):
    # 1. Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ù…Ø³Ø§Ø±Ø§Øª Ù…Ø¹ÙŠÙ†Ø©
    excluded_paths = ["/auth/", "/billing/webhook"]
    if path in excluded_paths:
        return await call_next(request)
    
    # 2. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ user_id Ù…Ù† JWT
    user_id = get_user_from_token(request)
    
    # 3. Ø¬Ù„Ø¨ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
    subscription = await repo.get_by_user_id(user_id)
    
    # 4. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø´ØªØ±Ø§Ùƒ FREE Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯
    if not subscription:
        subscription = await create_free_subscription(user_id)
    
    # 5. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø§Ù„Ø©
    if subscription.status not in [ACTIVE, TRIALING]:
        return JSONResponse(402, {"detail": "Subscription inactive"})
    
    # 6. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø´Ù‡Ø±ÙŠ
    if subscription.monthly_agent_runs >= subscription.monthly_agent_runs_limit:
        return JSONResponse(402, {"detail": "Monthly limit exceeded"})
    
    # 7. Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯ (Ù„Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© ÙÙ‚Ø·)
    if path.startswith("/sessions"):
        subscription.monthly_agent_runs += 1
        await repo.update(subscription)
    
    # 8. Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©
    return await call_next(request)
```

#### â“ Ø£Ø³Ø¦Ù„Ø© Ø­Ø±Ø¬Ø©:
- [ ] **Q6:** Ù‡Ù„ ÙŠØªÙ… Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙÙŠ ÙƒÙ„ Ø·Ù„Ø¨ `/sessions/*`ØŸ
- [ ] **Q7:** Ù…Ø§Ø°Ø§ Ù„Ùˆ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø¨Ø¹Ø¯ ØªÙ†ÙÙŠØ° Ø§Ù„Ø·Ù„Ø¨ØŸ
- [ ] **Q8:** Ù‡Ù„ ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† trial_end Ø¹Ù†Ø¯ status=TRIALINGØŸ
- [ ] **Q9:** Ù…Ø§Ø°Ø§ ÙŠØ­Ø¯Ø« Ø¥Ø°Ø§ Ø§Ù†ØªÙ‡Øª trial_end ÙˆØ§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø§ ÙŠØ²Ø§Ù„ TRIALINGØŸ
- [ ] **Q10:** Ù‡Ù„ `/billing/webhook` Ù…Ø¹ÙÙŠ ØªÙ…Ø§Ù…Ø§Ù‹ Ù…Ù† MiddlewareØŸ

---

### ğŸ”´ Ù…Ù†Ø·Ù‚Ø© 3: Stripe Webhooks

#### Webhook Handlers Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:
```
1. checkout.session.completed
   â””â”€> ØªØ­Ø¯ÙŠØ« subscription Ø¨Ù€ BASIC/PRO

2. customer.subscription.created
   â””â”€> Ø±Ø¨Ø· stripe_subscription_id

3. customer.subscription.updated
   â””â”€> ØªØ­Ø¯ÙŠØ« cancel_at_period_end

4. customer.subscription.deleted
   â””â”€> Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù„Ù‰ FREE

5. invoice.paid
   â””â”€> reset monthly_agent_runs

6. invoice.payment_failed
   â””â”€> ØŸØŸØŸ Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ØŸ
```

#### â“ Ø£Ø³Ø¦Ù„Ø© Ø­Ø±Ø¬Ø©:
- [ ] **Q11:** Ù‡Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù€ webhooks Ø§Ù„Ù…Ø°ÙƒÙˆØ±Ø© Ù…ÙÙ†ÙØ°Ø©ØŸ
- [ ] **Q12:** Ù…Ø§Ø°Ø§ ÙŠØ­Ø¯Ø« Ø¹Ù†Ø¯ `invoice.payment_failed`ØŸ
- [ ] **Q13:** Ù‡Ù„ ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† `stripe-signature` ÙÙŠ ÙƒÙ„ webhookØŸ
- [ ] **Q14:** Ù…Ø§Ø°Ø§ Ù„Ùˆ ÙØ´Ù„ webhook handlerØŒ Ù‡Ù„ ÙŠØ¹ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©ØŸ
- [ ] **Q15:** Ù‡Ù„ ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¬Ù…ÙŠØ¹ webhook eventsØŸ

---

### ğŸ”´ Ù…Ù†Ø·Ù‚Ø© 4: Frontend â†” Backend Sync

#### API Endpoints:
```
GET    /api/v1/billing/subscription
POST   /api/v1/billing/create-checkout-session
POST   /api/v1/billing/create-portal-session
POST   /api/v1/billing/activate-trial
POST   /api/v1/billing/webhook
```

#### Frontend Types:
```typescript
interface SubscriptionResponse {
  id: string;
  user_id: string;
  plan: 'FREE' | 'BASIC' | 'PRO' | 'ENTERPRISE';
  status: 'ACTIVE' | 'TRIALING' | 'PAST_DUE' | 'CANCELED';
  monthly_agent_runs: number;
  monthly_agent_runs_limit: number;
  current_period_end?: string; // ISO date
  cancel_at_period_end: boolean;
  is_trial: boolean;
  trial_end?: string; // ISO date
}
```

#### â“ Ø£Ø³Ø¦Ù„Ø© Ø­Ø±Ø¬Ø©:
- [ ] **Q16:** Ù‡Ù„ Types ÙÙŠ Frontend ØªØ·Ø§Ø¨Ù‚ Backend ModelsØŸ
- [ ] **Q17:** Ù‡Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ API responseØŸ
- [ ] **Q18:** Ù‡Ù„ ÙŠØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ null/undefined Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ØŸ
- [ ] **Q19:** Ù‡Ù„ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® ISO formatted Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ØŸ
- [ ] **Q20:** Ù‡Ù„ useSubscription ÙŠØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø®Ø·Ø£ØŸ

---

### ğŸ”´ Ù…Ù†Ø·Ù‚Ø© 5: Multi-Tenancy

#### Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª:
```
1. ÙƒÙ„ user Ù„Ù‡ subscription ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·
   â””â”€> Index: subscriptions.user_id (unique)

2. ÙƒÙ„ session Ù…Ø±ØªØ¨Ø· Ø¨Ù€ user_id
   â””â”€> Index: sessions.user_id

3. BillingMiddleware ÙŠØ³ØªØ®Ø¯Ù… user_id Ù…Ù† JWT
   â””â”€> Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³ØªØ®Ø¯Ù… Ø¢Ø®Ø±

4. FileService ÙŠØ³ØªØ®Ø¯Ù… user_id Ù„Ù„Ø¹Ø²Ù„
   â””â”€> Ù…Ù„ÙØ§Øª ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹Ø²ÙˆÙ„Ø©
```

#### â“ Ø£Ø³Ø¦Ù„Ø© Ø­Ø±Ø¬Ø©:
- [ ] **Q21:** Ù‡Ù„ Index Ø¹Ù„Ù‰ subscriptions.user_id Ù…ÙˆØ¬ÙˆØ¯ ÙˆÙ…ÙØ·Ø¨Ù‚ØŸ
- [ ] **Q22:** Ù‡Ù„ Ø¬Ù…ÙŠØ¹ API endpoints ØªØ³ØªØ®Ø¯Ù… user_id Ù…Ù† JWTØŸ
- [ ] **Q23:** Ù‡Ù„ ÙŠÙ…ÙƒÙ† Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªØ¹Ø¯ÙŠÙ„ Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ø³ØªØ®Ø¯Ù… Ø¢Ø®Ø±ØŸ
- [ ] **Q24:** Ù‡Ù„ FileService ÙŠØªØ­Ù‚Ù‚ Ù…Ù† user_id Ù‚Ø¨Ù„ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ù„ÙØ§ØªØŸ
- [ ] **Q25:** Ù‡Ù„ ÙŠØªÙ… Ø¹Ø²Ù„ sandbox containers Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…ØŸ

---

### ğŸ”´ Ù…Ù†Ø·Ù‚Ø© 6: Authentication & Security

#### JWT Flow:
```
1. Login
   â””â”€> Generate access_token (30 min)
   â””â”€> Generate refresh_token (7 days)

2. Every Request
   â”œâ”€> Extract access_token from header
   â”œâ”€> Verify signature
   â”œâ”€> Check expiration
   â””â”€> Extract user_id

3. Token Refresh
   â”œâ”€> Send refresh_token
   â”œâ”€> Verify refresh_token
   â””â”€> Generate new access_token
```

#### â“ Ø£Ø³Ø¦Ù„Ø© Ø­Ø±Ø¬Ø©:
- [ ] **Q26:** Ù‡Ù„ ÙŠØªÙ… ØªØ®Ø²ÙŠÙ† refresh_tokens ÙÙŠ RedisØŸ
- [ ] **Q27:** Ù‡Ù„ ÙŠÙ…ÙƒÙ† Ø¥Ø¨Ø·Ø§Ù„ (revoke) tokensØŸ
- [ ] **Q28:** Ù…Ø§Ø°Ø§ ÙŠØ­Ø¯Ø« Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ
- [ ] **Q29:** Ù‡Ù„ JWT_SECRET_KEY Ù‚ÙˆÙŠ ÙˆØ¢Ù…Ù†ØŸ
- [ ] **Q30:** Ù‡Ù„ CORS Ù…ÙÙƒÙˆÙ† Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ù„Ù„Ø¥Ù†ØªØ§Ø¬ØŸ

---

### ğŸ”´ Ù…Ù†Ø·Ù‚Ø© 7: Database Schema

#### SubscriptionDocument:
```python
class SubscriptionDocument(BaseDocument[Subscription]):
    subscription_id: str = Field(index=True)
    user_id: str = Field(index=True)  # âš ï¸ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† unique!
    plan: SubscriptionPlan = Field(default=SubscriptionPlan.FREE)
    status: SubscriptionStatus = Field(default=SubscriptionStatus.ACTIVE)
    
    stripe_customer_id: Optional[str] = Field(default=None, index=True)
    stripe_subscription_id: Optional[str] = Field(default=None, index=True)
    stripe_price_id: Optional[str] = Field(default=None)
    
    current_period_start: Optional[datetime] = Field(default=None)
    current_period_end: Optional[datetime] = Field(default=None)
    cancel_at_period_end: bool = Field(default=False)
    canceled_at: Optional[datetime] = Field(default=None)
    
    monthly_agent_runs: int = Field(default=0)
    monthly_agent_runs_limit: int = Field(default=10)
    
    trial_start: Optional[datetime] = Field(default=None)
    trial_end: Optional[datetime] = Field(default=None)
    is_trial: bool = Field(default=False)
    
    created_at: datetime = Field(default_factory=lambda: datetime.now(timezone.utc))
    updated_at: datetime = Field(default_factory=lambda: datetime.now(timezone.utc))
```

#### â“ Ø£Ø³Ø¦Ù„Ø© Ø­Ø±Ø¬Ø©:
- [ ] **Q31:** Ù‡Ù„ user_id Ù„Ù‡ unique index ÙØ¹Ù„ÙŠØŸ
- [ ] **Q32:** Ù…Ø§ Ù‡Ùˆ Ø³Ù„ÙˆÙƒ is_trial vs trial_endØŸ
- [ ] **Q33:** Ù‡Ù„ ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« updated_at ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ØŸ
- [ ] **Q34:** Ù‡Ù„ ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© plan Ùˆ status valuesØŸ
- [ ] **Q35:** Ù…Ø§Ø°Ø§ ÙŠØ­Ø¯Ø« Ø¹Ù†Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ subscription Ø«Ø§Ù†ÙŠ Ù„Ù†ÙØ³ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ

---

## ğŸ“ Ø®Ø·Ø© Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©

### Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ÙƒÙˆØ¯ (Code Review) â±ï¸ 2-3 Ø³Ø§Ø¹Ø§Øª
```
âœ“ Ù‚Ø±Ø§Ø¡Ø© Ø¬Ù…ÙŠØ¹ Ù…Ù„ÙØ§Øª Backend Billing
  â”œâ”€ models/subscription.py
  â”œâ”€ repositories/subscription_repository.py
  â”œâ”€ infrastructure/external/billing/stripe_service.py
  â”œâ”€ infrastructure/middleware/billing_middleware.py
  â”œâ”€ interfaces/api/billing_routes.py
  â””â”€ infrastructure/models/documents.py

âœ“ Ù‚Ø±Ø§Ø¡Ø© Ø¬Ù…ÙŠØ¹ Ù…Ù„ÙØ§Øª Frontend Billing
  â”œâ”€ src/api/billing.ts
  â”œâ”€ src/composables/useSubscription.ts
  â”œâ”€ src/components/billing/*.vue
  â””â”€ src/views/SubscriptionSettings.vue

âœ“ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù†:
  â”œâ”€ ØªØ·Ø§Ø¨Ù‚ Types Ø¨ÙŠÙ† Frontend Ùˆ Backend
  â”œâ”€ ØµØ­Ø© Business Logic
  â”œâ”€ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
  â””â”€ Security Best Practices
```

### Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: ÙØ­Øµ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Database Validation) â±ï¸ 1 Ø³Ø§Ø¹Ø©
```
âœ“ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Indexes
  â”œâ”€ subscriptions.user_id (unique) âš ï¸ Ø­Ø±Ø¬
  â”œâ”€ subscriptions.subscription_id
  â”œâ”€ subscriptions.stripe_customer_id
  â””â”€ subscriptions.stripe_subscription_id

âœ“ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Constraints
  â”œâ”€ plan ÙÙŠ [FREE, BASIC, PRO, ENTERPRISE]
  â”œâ”€ status ÙÙŠ [ACTIVE, TRIALING, PAST_DUE, CANCELED]
  â””â”€ monthly_agent_runs >= 0

âœ“ ÙØ­Øµ Data Integrity
  â”œâ”€ Ù‡Ù„ ÙƒÙ„ user Ù„Ù‡ subscription ÙˆØ§Ø­Ø¯ØŸ
  â”œâ”€ Ù‡Ù„ monthly_agent_runs <= monthly_agent_runs_limit Ù…Ù†Ø·Ù‚ÙŠØŸ
  â””â”€ Ù‡Ù„ trial_end > trial_start Ø¹Ù†Ø¯ is_trial=TrueØŸ
```

### Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª (Scenario Testing) â±ï¸ 3-4 Ø³Ø§Ø¹Ø§Øª
```
ğŸ§ª Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ 1: User Registration â†’ FREE Subscription
  1. POST /auth/register
  2. Verify: subscription created with plan=FREE, limit=10, runs=0
  3. Verify: MongoDB document exists
  4. Verify: GET /billing/subscription returns correct data

ğŸ§ª Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ 2: Trial Activation
  1. POST /billing/activate-trial
  2. Verify: status=TRIALING, trial_end=now+14days, limit=50
  3. Verify: cannot activate trial twice
  4. Verify: trial_end is enforced by middleware

ğŸ§ª Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ 3: Upgrade to BASIC
  1. POST /billing/create-checkout-session (plan=BASIC)
  2. Complete Stripe Checkout (use test mode)
  3. Verify: webhook checkout.session.completed received
  4. Verify: subscription updated (plan=BASIC, limit=1000, runs=0)
  5. Verify: Frontend reflects changes

ğŸ§ª Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ 4: Monthly Reset
  1. Simulate webhook invoice.paid
  2. Verify: monthly_agent_runs reset to 0
  3. Verify: current_period_end updated

ğŸ§ª Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ 5: Cancellation
  1. POST /billing/create-portal-session
  2. Cancel subscription via Stripe Portal
  3. Verify: webhook customer.subscription.updated received
  4. Verify: cancel_at_period_end=True
  5. Verify: access continues until period_end

ğŸ§ª Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ 6: Usage Limit Enforcement
  1. Run agent sessions until monthly_agent_runs >= limit
  2. Verify: next request returns HTTP 402
  3. Verify: Frontend shows "Upgrade" message

ğŸ§ª Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ 7: Multi-User Isolation
  1. Create User A with BASIC subscription
  2. Create User B with FREE subscription
  3. Verify: User A cannot access User B's subscription
  4. Verify: BillingMiddleware enforces isolation
```

### Ø§Ù„Ù…Ø±Ø­Ù„Ø© 4: Ø§Ø®ØªØ¨Ø§Ø± Stripe Integration â±ï¸ 2 Ø³Ø§Ø¹Ø§Øª
```
âœ“ Webhook Testing (Ø§Ø³ØªØ®Ø¯Ø§Ù… Stripe CLI)
  stripe listen --forward-to http://localhost:8000/api/v1/billing/webhook
  
  1. Test: checkout.session.completed
  2. Test: customer.subscription.updated
  3. Test: customer.subscription.deleted
  4. Test: invoice.paid
  5. Test: invoice.payment_failed
  
  âœ“ Verify: Ø¬Ù…ÙŠØ¹ webhooks ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
  âœ“ Verify: webhook signature verification works
  âœ“ Verify: error handling Ù„Ù€ invalid webhooks

âœ“ Checkout Flow Testing
  1. Create checkout session
  2. Complete payment with test card (4242 4242 4242 4242)
  3. Verify: redirect to success URL
  4. Verify: subscription updated correctly

âœ“ Customer Portal Testing
  1. Create portal session
  2. Update payment method
  3. Cancel subscription
  4. Verify: all actions reflected in database
```

### Ø§Ù„Ù…Ø±Ø­Ù„Ø© 5: Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ù…Ø§Ù† (Security Audit) â±ï¸ 1-2 Ø³Ø§Ø¹Ø§Øª
```
âœ“ JWT Security
  â”œâ”€ Verify: JWT_SECRET_KEY not exposed
  â”œâ”€ Verify: Token expiration enforced
  â”œâ”€ Verify: Token signature validated
  â””â”€ Verify: Refresh token rotation works

âœ“ Stripe Security
  â”œâ”€ Verify: STRIPE_SECRET_KEY not exposed
  â”œâ”€ Verify: Webhook signature verified
  â”œâ”€ Verify: Idempotency keys used
  â””â”€ Verify: Test mode vs Production mode

âœ“ API Security
  â”œâ”€ Verify: CORS properly configured
  â”œâ”€ Verify: Rate limiting (if applicable)
  â”œâ”€ Verify: Input validation on all endpoints
  â””â”€ Verify: SQL injection prevention (MongoDB)

âœ“ Multi-Tenancy Security
  â”œâ”€ Verify: user_id isolation enforced
  â”œâ”€ Verify: No cross-user data leakage
  â””â”€ Verify: Sandbox container isolation
```

### Ø§Ù„Ù…Ø±Ø­Ù„Ø© 6: Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚ (Documentation Review) â±ï¸ 1 Ø³Ø§Ø¹Ø©
```
âœ“ Ù‚Ø±Ø§Ø¡Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚
  â”œâ”€ BILLING_COMPLETE_REPORT.md
  â”œâ”€ BILLING_IMPLEMENTATION_SUMMARY.md
  â”œâ”€ BILLING_INTEGRATION_COMPLETE.md
  â”œâ”€ FRONTEND_BILLING_COMPLETE.md
  â”œâ”€ SAAS_TRANSFORMATION_COMPLETE.md
  â”œâ”€ QUICK_TEST_GUIDE.md
  â””â”€ BEANIE_CONFIGURATION_GUIDE.md

âœ“ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù†:
  â”œâ”€ Ø¯Ù‚Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙ‚Ù†ÙŠØ©
  â”œâ”€ ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚ Ù…Ø¹ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙØ¹Ù„ÙŠ
  â”œâ”€ ÙˆØ¶ÙˆØ­ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª
  â””â”€ Ø§ÙƒØªÙ…Ø§Ù„ Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯
```

### Ø§Ù„Ù…Ø±Ø­Ù„Ø© 7: Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙ†Ø§Ù‚Ø¶Ø§Øª (Findings Report) â±ï¸ 1 Ø³Ø§Ø¹Ø©
```
âœ“ ØªØ¬Ù…ÙŠØ¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙ†Ø§Ù‚Ø¶Ø§Øª
âœ“ ØªØµÙ†ÙŠÙÙ‡Ø§ Ø­Ø³Ø¨ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©:
  - ğŸ”´ Critical (ÙŠØ¬Ø¨ Ø¥ØµÙ„Ø§Ø­Ù‡ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ù†ØªØ§Ø¬)
  - ğŸŸ¡ Medium (ÙŠÙÙØ¶Ù„ Ø¥ØµÙ„Ø§Ø­Ù‡)
  - ğŸŸ¢ Low (ØªØ­Ø³ÙŠÙ†Ø§Øª Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ©)

âœ“ Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø·Ø© Ø¥ØµÙ„Ø§Ø­:
  - Owner (Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø¥ØµÙ„Ø§Ø­)
  - Deadline (Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ)
  - Testing Plan (Ø®Ø·Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±)
```

---

## ğŸ“Š Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ù†Ø¬Ø§Ø­

### âœ… Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ù†Ø§Ø¬Ø­Ø© Ø¥Ø°Ø§:
1. **Data Consistency:** 100% ØªØ·Ø§Ø¨Ù‚ Ø¨ÙŠÙ† Models Ùˆ Documents
2. **Business Logic:** Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ù…Ù†Ø·Ù‚ÙŠØ© ÙˆÙ…ØªØ³Ù‚Ø©
3. **Integration:** Stripe webhooks ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
4. **Security:** Ù„Ø§ ØªÙˆØ¬Ø¯ Ø«ØºØ±Ø§Øª Ø£Ù…Ù†ÙŠØ© ÙˆØ§Ø¶Ø­Ø©
5. **Multi-Tenancy:** Ø¹Ø²Ù„ ÙƒØ§Ù…Ù„ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
6. **Documentation:** Ø¯Ù‚ÙŠÙ‚Ø© ÙˆÙ…ØªØ·Ø§Ø¨Ù‚Ø© Ù…Ø¹ Ø§Ù„ÙƒÙˆØ¯

### âš ï¸ Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø®Ø·Ø±:
- âŒ Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ù…ØªØ¹Ø¯Ø¯Ø© Ù„Ù†ÙØ³ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
- âŒ monthly_agent_runs Ù„Ø§ ÙŠÙØ­Ø¯Ù‘Ø« Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
- âŒ Webhooks ØªÙØ´Ù„ Ø¨ØµÙ…Øª
- âŒ ØªØ³Ø±Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨ÙŠÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
- âŒ JWT tokens Ù„Ø§ ØªÙ†ØªÙ‡ÙŠ ØµÙ„Ø§Ø­ÙŠØªÙ‡Ø§
- âŒ Stripe keys Ù…ÙƒØ´ÙˆÙØ© ÙÙŠ Ø§Ù„ÙƒÙˆØ¯

---

## ğŸ¯ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©

### Ø¨Ø¹Ø¯ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©:
1. **Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙ†Ø§Ù‚Ø¶Ø§Øª Ø§Ù„Ø­Ø±Ø¬Ø©** (Ø¥Ù† ÙˆÙØ¬Ø¯Øª)
2. **Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª**
3. **ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚** (Ø¥Ù† Ù„Ø²Ù…)
4. **Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Phase 8: Production Deployment**

### Phase 8 Preview:
```
- Docker Compose Production Setup
- Nginx Reverse Proxy + SSL
- Monitoring & Logging (Sentry)
- Database Backups
- CI/CD Pipeline
- Beta Testing
- Launch ğŸš€
```

---

## ğŸ“ Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„

**Project Owner:** AI-Manus Team  
**Repository:** https://github.com/raglox/ai-manus  
**Branch:** main  
**Last Commit:** 1ef3112  
**Date:** 2025-12-26

---

**Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¨Ø¯Ø£Øª:** ğŸ• Ø§Ù„Ø¢Ù†  
**Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…Ù‚Ø¯Ø±Ø©:** â±ï¸ 12-15 Ø³Ø§Ø¹Ø©  
**Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©:** ğŸ”´ Ø¹Ø§Ù„ÙŠØ© Ø¬Ø¯Ø§Ù‹  
**Ø§Ù„Ø­Ø§Ù„Ø©:** ğŸ“ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°
